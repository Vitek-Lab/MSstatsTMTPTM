---
title: "MSstatsTMTPTM Example: An example workflow and analysis of the MSstatsTMTPTM package"
author: "Devon Kohler (<kohler.d@northeastern.edu>)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MSstatsTMTPTM Example: An example workflow and analysis of the MSstatsTMTPTM package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=8, 
  fig.height=8
)
```

```{r, message=FALSE, warning=FALSE}
library(MSstatsTMTPTM)
library(MSstatsTMT)
library(MSstats)
library(dplyr)
```

This Vignette provides an example workflow for how to use the package MSstatsTMTPTM. It also provides examples and an analysis of how adjusting for global protein levels allows for better interpretations of PTM modeling results.

## 1. Workflow

### 1.1 Raw Data Format

#### 1.1.1 Raw PTM Data

```{r}
# read in raw data files
# raw.ptm <- read.csv(file="raw.ptm.csv", header=TRUE)
head(raw.ptm)
```

The first step is to load in the raw dataset for both the PTM and Protein datasets. This can be the output of the MSstatsTMT converter functions: `PDtoMSstatsTMTFormat`, `MaxQtoMSstatsTMTFormat`, `SpectroMinetoMSstatsTMTFormat`. The dataset must include the columns: `ProteinName`, `PeptideSequence`, `Charge`, `PSM`, `Mixture`, `TechRepMixture`, `Run`, `Channel`, `Condition`, `BioReplicate`, and `Intensity`. It is important to note the `ProteinName` column. The location of the modification must be added into the ProteinName. For example the first row shows `Protein_4_Y474` for ProteinName, with Y474 being the modificaiton site. This can be done as shown above, or by adding the PeptideSequence into the ProteinName, ex. `Protein_4_Peptide_455` for the first row.

#### 1.1.1 Raw Protein Data

``` {r}
head(raw.protein)
# raw.protein <- read.csv(file="raw.protein.csv", header=TRUE)
```

Load in the raw Protein dataset as well. This is the same as the PTM data, however the `ProteinName` column does not contain a modification site.

### 1.2 proteinSummarization

``` {r, results='hide', message=FALSE, warning=FALSE}

# Use proteinSummarization function from MSstatsTMT to summarize raw data
quant.msstats.ptm <- proteinSummarization(raw.ptm,
                                          method = "msstats",
                                          global_norm = TRUE,
                                          reference_norm = FALSE,
                                          MBimpute = TRUE)

quant.msstats.protein <- proteinSummarization(raw.protein,
                                          method = "msstats",
                                          global_norm = TRUE,
                                          reference_norm = FALSE,
                                          MBimpute = TRUE)

```

``` {r}
head(quant.msstats.ptm)
head(quant.msstats.protein)
```

After loading in the input data, the next step is to use the proteinSummarization function from MSstatsTMT. This provides the summarized dataset needed to model the protein/PTM abundance. With the modification site added into the protein name, this function will summarize the data for each PTM.


### 1.3 groupComparisonTMTPTM

``` {r, results='hide', message=FALSE, warning=FALSE}

# test for all the possible pairs of conditions
test.pairwise <- groupComparisonTMTPTM(data.ptm=quant.msstats.ptm,
                                       data.protein=quant.msstats.protein)

# Load specific contrast matrix
# example.comparisons <- read.csv(file="example.comparisons.csv", header=TRUE)
example.comparisons

# test for specified condition comparisons only
test.example.comparisons <- groupComparisonTMTPTM(data.ptm=quant.msstats.ptm,
                                       data.protein=quant.msstats.protein,
                                       contrast.matrix = example.comparisons)

```

``` {r}
names(test.example.comparisons)
ptm_model <- test.example.comparisons[[1]]
protein_model <- test.example.comparisons[[2]]
adjusted_model <- test.example.comparisons[[3]]

head(adjusted_model)

```

The modeling function will return a list consisting of three dataframes. One each for the PTM, Protein, and Adjusted PTM models. Using these dataframes modeling plots can be created using the groupComparisonPlots function from MSstats.

### 1.4 Example Volcano Plot

``` {r}
groupComparisonPlots(data = adjusted_model,
                     type = 'VolcanoPlot',
                     ProteinName = FALSE,
                     which.Comparison = '1-4',
                     address = FALSE)

```

The dataframes from the groupComparisonTMTPTM function are compatible with the groupComparisonPlots function from MSstats and the plots can be used to analyze the models.

## 2. Analysis

### 2.1 How to adjust PTMs for changes in global protein levels?

First we model both the PTM and global protein datasets with the MSstatsTMT groupcomparison function (as noted by the modeling formula above). The resulting modeling parameters are then combined using the adjustment formulas below:

Log2FC: $\log_2FC_{PTM} - \log_2FC_{Protein}$

SE: $\sqrt{SE_{PTM}^2 + SE_{Protein}^2}$

DF: $(SE_{PTM}^2 + SE_{Protein}^2)^2 \biggm/ (\frac{SE_{PTM}^2}{DF_{PTM}} + \frac{SE_{Protein}^2}{DF_{Protein}})$

Please see the package MSstatsPTM for further explanation of adjustment strategy and formulas.

### 2.2 Example PTM

``` {r}
dataProcessPlotsTMTPTM(data.ptm = raw.ptm,
                       data.protein = raw.protein,
                       data.ptm.summarization = quant.msstats.ptm,
                       data.protein.summarization = quant.msstats.protein,
                       type = 'ProfilePlot',
                       which.Protein = 2,
                       address = FALSE)

```

In the plots above the data points for the PTM `Protein_1145_T915` and Protein `Protein_1145` are shown for all conditions. To take a look at a specific comparison, the input data can be filtered.

``` {r}
dataProcessPlotsTMTPTM(data.ptm = raw.ptm %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       data.protein = raw.protein %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       data.ptm.summarization = quant.msstats.ptm %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       data.protein.summarization = quant.msstats.protein %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       type = 'ProfilePlot',
                       which.Protein = 'Protein_1145_T915',
                       originalPlot = FALSE,
                       address = FALSE)

model_df <- rbind(adjusted_model %>% filter(Protein == 'Protein_1145_T915' & Label == '2-5') %>% select(-Tvalue),
                  ptm_model %>% filter(Protein == 'Protein_1145_T915' & Label == '2-5') %>% select(-issue),
                  protein_model %>% filter(Protein == 'Protein_1145' & Label == '2-5') %>% select(-issue))

rownames(model_df) <- c('Adjusted PTM', 'PTM', 'Protein')
model_df
```

The example above shows the added insight of adjusting for Protein level. Originally the PTM model shows a slight log2FC of -0.425. However, the global protein level changed in the opposite direction at 0.508. When the PTM is adjusted for the global the log2FC is now -0.932 which is a much larger change than without adjustment. The change in abundance of this PTM may have been marked as insignificant without adjusting for protein levels. Note the change in SE and DF once the PTM model is adjusted.

Additionally, log2FC can be reduced after adjustment.

``` {r}
dataProcessPlotsTMTPTM(data.ptm = raw.ptm %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       data.protein = raw.protein %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       data.ptm.summarization = quant.msstats.ptm %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       data.protein.summarization = quant.msstats.protein %>% filter(Condition %in% c('Condition_2', 'Condition_5')),
                       type = 'ProfilePlot',
                       which.Protein = 'Protein_1076_Y67',
                       originalPlot = FALSE,
                       address = FALSE)

model_df <- rbind(adjusted_model %>% filter(Protein == 'Protein_1076_Y67' & Label == '2-5') %>% select(-Tvalue),
                  ptm_model %>% filter(Protein == 'Protein_1076_Y67' & Label == '2-5') %>% select(-issue),
                  protein_model %>% filter(Protein == 'Protein_1076' & Label == '2-5') %>% select(-issue))

rownames(model_df) <- c('Adjusted PTM', 'PTM', 'Protein')
model_df
```

In this example the PTM model originally showed a large log2FC of 0.242, however most of this FC was a result of the global protein which was 0.356. Once adjusted, the PTM shows a much smalled FC of -0.114. Without adjustment a potentially incorrect inference could have been drawn for this PTM.




